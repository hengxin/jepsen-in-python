# 搭建你的分布式系统
本章节中将以etcd为例，介绍如何搭建分布式系统

## 服务器配置
在配置文件config.yaml中以如下结构罗列服务器的相关配置，账号需要拥有root权限
```yaml
server:
  client1:
    hostname: node1 # hostname of your server
    port: 22 # your port of ssh
    username: # your username
    password: # your login password
  client2:
    hostname: node2 # hostname of your server
    port: 22 # your port of ssh
    username: # your username
    password: # your login password
  client3:
    hostname: node3 # hostname of your server
    port: 22 # your port of ssh
    username: # your username
    password: # your login password
  ...
```



## 继承database_op基类
你需要自己定义数据库的启动(set_up)、关闭(shut_down)、连接(connect_database)、断连接(disconnect_database)和检测(is_running)方法
以etcd3为例,如果有三台服务器
在配置文件config.yaml中配置搭建数据库需要的相关变量
```yaml
database:
  initial_cluster: "node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380"
  port: 2379
```
```python
class etcd_database(database_op):
    def __init__(self, ssh_client, hostname, config):
        super().__init__(ssh_client, hostname, config)
        self.port = config["port"]
        self.initial_cluster = config["initial_cluster"]
        self.database_connection = None
        
    def setup(self):
        root_path = self.ssh_client.pwd() + "/tmp/"
        self.ssh_client.wget(url="https://storage.googleapis.com/etcd/v3.1.5/etcd-v3.1.5-linux-amd64.tar.gz")
        self.ssh_client.mkdir(root=root_path, filename="etcd")
        self.ssh_client.unzip(file_name="{}etcd-v3.1.5-linux-amd64.tar.gz".format(root_path),
                              opts={
                                  "-C": root_path + "/etcd",
                                  "--strip-components": 1
                              })
        self.ssh_client.touch(root=root_path, filename="etcd.log")
        self.ssh_client.exec_sudo_command(command="{}etcd/etcd".format(root_path),
                                          opts={
                                              "--log-output": "stdout",
                                              "--name": self.hostname,
                                              "--listen-peer-urls": "http://0.0.0.0:2380",
                                              "--listen-client-urls": "http://0.0.0.0:2379",
                                              "--advertise-client-urls": "http://{0}:2379".format(self.hostname),
                                              "--initial-cluster-state": "new",
                                              "--initial-advertise-peer-urls": "http://{0}:2380".format(self.hostname),
                                              "--initial-cluster": self.initial_cluster,
                                              "1>{}etcd.log".format(root_path): ""
                                          })

    def shutdown(self):
        root_path = self.ssh_client.pwd() + "/*"
        self.ssh_client.kill_by_process("etcd")
        self.ssh_client.exec_sudo_command("rm -rf {}".format(root_path))

    def connect_database(self):
        self.database_connection = etcd3.client(host=self.hostname, port=self.port)

    def disconnect_database(self):
        if self.database_connection:
            self.database_connection.close()
            self.database_connection = None
        else:
            pass

    def is_running(self):
        running = self.ssh_client.exec_command("ps -ef|grep etcd|grep -v grep|grep -v wget|awk '{print $2}'",
                                               return_result=True)
        return len(running) >= 1


database = etcd_database
```